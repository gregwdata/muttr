name: Deploy muttr Azure Functions (global hops)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: muttr-rg
  AZURE_STORAGE_ACCOUNT: muttrfuncstorage123
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'
  NODE_VERSION: '20.x'

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        hop:
          - name: muttr-us-east
            region: eastus
            hopName: us-east-hop
            nextUrl: https://muttr-brazil.azurewebsites.net/api/muttr
            prevUrl: ""
            delayMs: "100"
            isFinal: "false"

          - name: muttr-brazil
            region: brazilsouth
            hopName: brazil-hop
            nextUrl: https://muttr-uk.azurewebsites.net/api/muttr
            prevUrl: https://muttr-us-east.azurewebsites.net/api/muttr
            delayMs: "150"
            isFinal: "false"

          - name: muttr-uk
            region: uksouth
            hopName: uk-hop
            nextUrl: https://muttr-singapore.azurewebsites.net/api/muttr
            prevUrl: https://muttr-brazil.azurewebsites.net/api/muttr
            delayMs: "200"
            isFinal: "false"

          - name: muttr-singapore
            region: southeastasia
            hopName: singapore-hop
            nextUrl: https://muttr-sydney.azurewebsites.net/api/muttr
            prevUrl: https://muttr-uk.azurewebsites.net/api/muttr
            delayMs: "300"
            isFinal: "false"

          - name: muttr-sydney
            region: australiaeast
            hopName: sydney-hop
            nextUrl: ""
            prevUrl: https://muttr-singapore.azurewebsites.net/api/muttr
            delayMs: "400"
            isFinal: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure resource group exists
        run: |
          az group create \
            --name "$AZURE_RESOURCE_GROUP" \
            --location "${{ matrix.hop.region }}"

      - name: Ensure storage account exists
        if: matrix.hop.name == 'muttr-us-east'
        run: |
          if ! az storage account show -n "$AZURE_STORAGE_ACCOUNT" -g "$AZURE_RESOURCE_GROUP" >/dev/null 2>&1; then
            az storage account create \
              -n "$AZURE_STORAGE_ACCOUNT" \
              -g "$AZURE_RESOURCE_GROUP" \
              -l "${{ matrix.hop.region }}" \
              --sku Standard_LRS \
              --kind StorageV2
          fi

      - name: Ensure function app exists
        run: |
          APP_NAME="${{ matrix.hop.name }}"
          REGION="${{ matrix.hop.region }}"

          if ! az functionapp show -g "$AZURE_RESOURCE_GROUP" -n "$APP_NAME" >/dev/null 2>&1; then
            az functionapp create \
              --name "$APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --storage-account "$AZURE_STORAGE_ACCOUNT" \
              --consumption-plan-location "$REGION" \
              --runtime node \
              --functions-version 4 \
              --os-type Linux
          fi

      - name: Configure hop settings
        run: |
          APP_NAME="${{ matrix.hop.name }}"

          SETTINGS="HOP_NAME=${{ matrix.hop.hopName }} NEXT_HOP_URL=${{ matrix.hop.nextUrl }} PREV_HOP_URL=${{ matrix.hop.prevUrl }} DELAY_MS=${{ matrix.hop.delayMs }}"

          az functionapp config appsettings set \
            -g "$AZURE_RESOURCE_GROUP" \
            -n "$APP_NAME" \
            --settings $SETTINGS

          if [ "${{ matrix.hop.isFinal }}" = "true" ]; then
            az functionapp config appsettings set \
              -g "$AZURE_RESOURCE_GROUP" \
              -n "$APP_NAME" \
              --settings OPENROUTER_MODEL="openai/gpt-4o-mini" OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}"
          else
            az functionapp config appsettings delete \
              -g "$AZURE_RESOURCE_GROUP" \
              -n "$APP_NAME" \
              --setting-names OPENROUTER_API_KEY OPENROUTER_MODEL >/dev/null 2>&1 || true
          fi

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ matrix.hop.name }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
